<html>
    <head>
      <meta charset="UTF-8" />
      <meta http-equiv="X-UA-Compatible" content="IE=edge" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>User Page</title>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css" />

      <link rel="stylesheet" href="./user.css">
      <link rel="stylesheet" href="./framework.css">
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
      <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700&display=swap" rel="stylesheet">

    </head>
    <body>


      <div class="loginDiv">

        <div class="containerDad">
          <div class="flex gap-2 mx-5" style="position: absolute;  top: 0;  right: 0;  margin: 15px;">
            
            <!-- <button class="" type="button">
              <span class="mx-2 my-auto">نسخة تجريبية</span>
            </button> -->

            <button class="signup-box-show" type="button">
              <span class="mx-2 my-auto">سجل الآن</span>
            </button>

            <button class="login-box-show" style="display: none;" type="button">
              <span class="mx-2 my-auto">تسجيل الدخول</span>
            </button>

          </div>

          <div class="container">
            <div class="login-box">
              <img src="./imgs/logo.svg" alt="Logo" class="logo">
              <h2>الرؤيا الرقمية للواتساب</h2>
              <input class="login-email" type="email" placeholder="البريد الإلكتروني">
              <input class="login-password" type="password" placeholder="كلمة المرور">
              <button class="login-btn">تسجيل الدخول</button>
            </div>


            <div class="signup-box" style="display: none;">
              <img src="./imgs/logo.svg" alt="Logo" class="logo">
              <h2>إنشاء حساب جديد</h2>
              <input  class="signup-name"  type="text" placeholder="الاسم الكامل">
              <input class="signup-phone" type="text" placeholder="رقم الهاتف">
              <input class="signup-email" type="email" placeholder="البريد الإلكتروني">
              <input class="signup-password" type="password" placeholder="كلمة المرور">
              <button class="signup-btn">إنشاء حساب</button>
            </div>




          </div>

        </div>
        
      
      </div>




      <div class="page d-flex">
      
        <div class="content w-full">
  
          <!-- Start Head -->
          <div class="head bg-white between-flex" style="padding: 10px 20px; background: #226ab2;">
            <div class="icons d-flex align-center">
              <!-- <img style="width: 50px; height: 50px; background: white; padding: 2px; border-radius: 50%;" src="./imgs/logo.svg" alt=""> -->
            </div>

            <div class="p-relative">
              <h2 class="p-relative pageName" style="text-align: center;">الرئيسية</h2>
            </div>

            <button class="HiddeLeftPar" style="font-size: 20px;
            font-family: cairo;
            cursor: pointer;
            width: 50px;
            border-radius: 10px;
            padding: 5px 0px;
            font-weight: 600;
            border: none;
            background: white;
            color: black;">
              <i class="fa-solid fa-bars"></i>
            </button>


          </div>
          <!-- End Head -->




          <div class="page-content HomePage">

            <div>




              <div class="container">
                  <h1>مخططات الرسائل بالذكاء الاصطناعي</h1>
                  <!-- <div class="charts">
                      <div class="chart-container" id="combinedChartContainer">
                          <canvas id="combinedChart" style="display: block; box-sizing: border-box; height: 300px; width: 780px;"></canvas>
                      </div>
                  </div> -->

                  <br>

                    <div class="progress-container" style="display: flex; flex-wrap: wrap; justify-content: space-around; gap: 20px;     align-items: center;">

              

                      <div style="width: 100%; max-width: 400px; text-align: center;">
                        <h1>الليميت اليومي</h1>
                        <div class="daily-progress" style="display: flex; justify-content: center;"></div>
                        <div class="daily-progress-text"></div>
                      </div>

                      <div class="chart-container" id="combinedChartContainer">
                        <canvas id="combinedChart" style="display: block; box-sizing: border-box; height: 300px; width: 780px;"></canvas>
                      </div>

                      <div style="width: 100%; max-width: 400px; text-align: center;">
                        <h1>الليميت المتاح</h1>
                        <div class="monthly-progress" style="display: flex; justify-content: center;"></div>
                        <div class="monthly-progress-text"></div>
                      </div>

                    </div>

                    <div style="text-align: center; margin-top: 20px; color: #226ab2;">
                      <!-- <h2>معلومات إضافية</h2> -->
                      <p>يتم احتساب الاستخدام بدا من تاريخ الاشتراك</p>
                    </div>

              </div>



              <div style="margin: 0 20px;">
                <div class="summary-container" style="text-align: center; margin: 20px 0;">
                  <h3 style="color: #226ab2;">احصل على ملخص وتحليل الرسائل</h3>
                  <div class="summary-buttons" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; justify-content: center; ">
                  <button onclick="fetchAiMessageSummary('day')" style="padding: 5px 10px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-family: cairo;">اليوم</button>
                  <button onclick="fetchAiMessageSummary('week')" style="padding: 5px 10px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-family: cairo;">هذا الأسبوع</button>
                  <!-- <button onclick="fetchAiMessageSummary('month')" style="padding: 5px 10px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-family: cairo;">هذا الشهر</button> -->
                  <!-- <button onclick="fetchAiMessageSummary('year')" style="padding: 5px 10px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-family: cairo;">هذا العام</button> -->
                  </div>
                </div>
              </div>

            </div>


          </div>






          <div class="page-content WhatsAppQrPage" style="display: none;">

            <div style="display: flex; justify-content: center;">
              <button style="max-width: 400px;" class="logout-btn" onclick="logoutUser()">تغيير رقم الهاتف</button>
            </div>

            <br>


            <div class="qrDiv" style="display: block;">

              <button class="startScanQrBtn" onclick="startScanQr()" style="font-weight: bold; font-family: cairo;  width: 200px; display: block; margin: 20px auto; border-radius: 10px;">مسح كود الواتساب</button>
              
              <div class="scanUserQrDiv" style="display: none; max-width: 500px; margin: auto;">
                <h2 style="color: black; text-align: center;">برجاءالانتظار لمسح كود الواتساب</h2>
                <div style="display: flex; justify-content: center; margin: 20px auto;">
                  <img class="qrCodeImg" style=" border-radius: 20px; border: none; width: 300px; height: 300px;" src="./imgs/loading.jpg" alt="QR Code">
                </div>
                <br>
                <h2 style="color: black; text-align: center;">بعد مسح الكود برجاء عمل ريفرش للصفحة</h2>
              </div>
            </div>
      
      
  



          </div>







          <div class="page-content WhatsAppChatbotPage" style="display: none;">

            <div class="mainUserDiv" style="display: block;">

              <div class="tools">
                  
      
                <div style="display: flex; justify-content: end;">
                  <button id="startBtn" onclick="toggleChatbot(true)" style="margin: 10px; display: none;">تشغيل البوت</button>
                  <button id="stopBtn" onclick="toggleChatbot(false)" style="margin: 10px; display: block;">ايقاف البوت</button>
                  <button class="setHoursButton" onclick="setChatbotHours()" style="margin: 10px;"> مواعيد عمل البوت </button>
                </div>
      
                <button class="saveRulesBtn" onclick="saveRules()">حفظ </button>

              </div>

              <div>

                <h2 style="text-align: center; color: black;">قواعد الذكاء الاصطناعي للرد علي العملاء</h2>
           
                <div style="margin: auto; border-radius: 20px; overflow: hidden; display: flex; justify-content: center; height: 70vh;">
                  <textarea dir="auto" class="mainRules" name="rules" rows="15" placeholder="Enter rules for the chatbot..."></textarea>
                </div>
           
                        
              </div>
      
                      
            </div>

          </div>



          <div class="page-content WhatsAppSenderPage" style="display: none;">

            <!-- <div style="display: flex;justify-content: space-around;align-content: center;align-items: center;padding: 10px;">
              <div>
                <label for="fileUpload" style=" background: green; padding: 5px 10px; border-radius: 10px; color: #fff; cursor: pointer; font-family: cairo; font-weight: bold;">رفع ملف اكسيل</label>
                <input type="file" id="fileUpload" accept=".xlsx, .xls, .csv" style="margin-bottom: 20px; display: none;">
              </div>
              <button style="max-width: 400px;" id="downloadBtn" onclick="downloadPhoneNumbers()">تحميل جميع ارقام هواتف جهات الاتصال</button>
              
            </div> -->


            <div class="file-upload-container">
  
              <div class="upload-section">
                <label for="fileUpload" class="upload-label">رفع ملف اكسيل</label>
                <input type="file" id="fileUpload" accept=".xlsx, .xls, .csv" hidden>
              </div>
            
              <button id="downloadBtn" class="download-button" onclick="downloadPhoneNumbers()">تحميل جميع ارقام هواتف جهات الاتصال</button>
            
            </div>
            

            <div style=" color: black; text-align: center;">
              
              <div class="swal2-html-container" id="swal2-html-container" style="display: block;">
                <h2 style="text-align: center; color: black;"> الرسالة </h2>
                <div style=" margin: auto; border-radius: 20px; overflow: hidden; display: flex; justify-content: center;">
                  <textarea dir="auto" class="messageTextareaForSender" name="rules" rows="15" placeholder="Enter rules for the chatbot..."></textarea>
                </div>

                <!-- <div style="text-align: end; padding: 20px; font-family: cairo; font-weight: bold;">
                  
                  <div style="display: flex; justify-content: space-around; text-align: center;">

                    <div>
                      <label for="countryCode">كود الدولة</label>
                      <br>
                      <div style="display: flex; justify-content: center;">
                        <input id="countryCode" style="margin: 5px; padding: 10px; border-radius: 8px; font-size: 15px;" class="input" type="text" value="20">
                      </div>
                    </div>
  
                    <div>
                      <label for="messageDelay">ارسال الرسالة كل فترة زمنية بالثواني</label>
                      <br>
                      <div style="display: flex; justify-content: center;">
                        <input id="messageDelay" style="margin: 5px; padding: 10px; border-radius: 8px; font-size: 15px;" class="swal2-input" type="number" value="2" required="">
                      </div>
                    </div>

                  </div>

                  <div style="display: flex; justify-content: space-around;">

                    <div>
                      <label for="batchDelay">انتظار فترة زمنية بعد كل مجموعه من الثواني</label>
                      <br>
                      <div style="display: flex; justify-content: center;">
                        <input id="batchDelay" style="margin: 5px; padding: 10px; border-radius: 8px; font-size: 15px;" class="swal2-input" type="number" value="10" required="">
                      </div>
                    </div>
  
  
  
                    <div>
                      <label for="messageCount">توقف بعد عدد معين من الرسائل لفترة زمنية</label>
                      <br>
                      <div style="display: flex; justify-content: center;">
                        <input id="messageCount" style="margin: 5px; padding: 10px; border-radius: 8px; font-size: 15px;" class="swal2-input" type="number" value="10" required="">
                      </div>
                    </div>
                    
                  </div>


                  <div style="display: flex; justify-content: center;">
                    <button style="max-width: 400px;" id="startWhatsAppSender" onclick="startWhatsAppSender()">بدا ارسال الرسائل</button>
                  </div>




                </div> -->


                <div class="settings-container">
  
                  <div class="grid-container">
                    
                    <div class="grid-item">
                      <label for="countryCode">كود الدولة</label>
                      <input id="countryCode" class="input" type="text" value="20">
                    </div>
                
                    <div class="grid-item">
                      <label for="messageDelay">ارسال الرسالة كل فترة زمنية بالثواني</label>
                      <input id="messageDelay" class="input" type="number" value="5" required>
                    </div>
                
                    <div class="grid-item">
                      <label for="batchDelay">انتظار فترة زمنية بعد عدد من الرسائل</label>
                      <input id="batchDelay" class="input" type="number" value="60" required>
                    </div>
                
                    <div class="grid-item">
                      <label for="messageCount">توقف بعد عدد معين من الرسائل </label>
                      <input id="messageCount" class="input" type="number" value="60" required>
                    </div>
                
                  </div>
                
                  <div class="button-container">
                    <button id="startWhatsAppSender" onclick="startWhatsAppSender()">بدا ارسال الرسائل</button>
                  </div>
                
                </div>
                
      
                
              </div>
            </div>

          </div>


          <div class="page-content SubscriptionPage" style="display: none;">
          </div>


          <div class="page-content ProfileSettingsPage" style="display: none;">

            <div class="user-data" style="border: 1px solid #eaeaea; padding: 15px; border-radius: 5px;">

            </div>


          </div>







  
      
  
        </div>
  
        <!-- Start Sidebar can copy it to anthor file -->
        <div class="sidebar p-20 p-relative">
      
          <div >

            <button class="HiddeLeftParSidebarBtn HiddeLeftParSidebarBtnHide">
              <i class="fa-solid fa-close HiddeLeftParSidebarBtnHide"></i>
            </button>
        
            <div class="sidebarLogoDiv" style="display: flex; justify-content: center; background: white; padding: 10px; margin: 0;">

              
              <img style="max-width: 50px; margin: 0 10px;" src="./imgs/logo.svg">
              <p style="color: #00000096; padding-top: 3px; font-size: 24px; font-weight: bold; margin: 0;"> Royaa WhatsApp</p>
                      
            </div>
          </div>
          
    
  
          <div>
            <bdi style="margin: 10px;">
              <h2 style="text-align: center;">اهلا <span id="AdminName" style="color: #397eaf"></span></h2>
            </bdi>
          </div>
          <ul>
            
            <li class="AllPagesBtns">
                
                <a class="active d-flex align-center c-black p-10 HomeLink" style="padding: 10px; font-weight: bold; font-size:18px; text-align: end;  background: transparent; color: white;display: flex; justify-content: end;" href="#">
  
                  لوحة التحكم

                </a>


                <a class="d-flex align-center c-black p-10 WhatsAppQrLink" style="padding: 10px; font-weight: bold; font-size:18px; text-align: end;  background: transparent; color: white;display: flex; justify-content: end;" href="#">
  
                  ربط الواتساب

                </a>

                <a class="d-flex align-center c-black p-10 WhatsAppChatbotLink" style="padding: 10px; font-weight: bold; font-size:18px; text-align: end;  background: transparent; color: white;display: flex; justify-content: end;" href="#">
  
                  الذكاء الاصطناعي

                </a>
                <a class="d-flex align-center c-black p-10 WhatsAppSenderLink" style="padding: 10px; font-weight: bold; font-size:18px; text-align: end;  background: transparent; color: white;display: flex; justify-content: end;" href="#">
  
                  ارسال رسائل الواتساب

                </a>
                <a class="d-flex align-center c-black p-10 SubscriptionLink" style="padding: 10px; font-weight: bold; font-size:18px; text-align: end;  background: transparent; color: white;display: flex; justify-content: end;" href="#">
  
                  تفاصيل الاشتراك

                </a>
                <a class="d-flex align-center c-black p-10 ProfileSettingsLink" style="padding: 10px; font-weight: bold; font-size:18px; text-align: end;  background: transparent; color: white;display: flex; justify-content: end;" href="#">
  
                  اعدادات الحساب

                </a>

                
            </li>
  
            <a class="Orders-Accepted active d-flex align-center fs-14 c-black p-10 LogoutBtn" style="display: flex; justify-content: end; cursor: pointer; background: rgba(137, 8, 8, 0.676); color: white;" id="logOut-digital" onclick="goToLogin()">
              <span style="font-weight: bold; font-size:20px;">تسجيل الخروج</span>
              <i class="fas fa-sign-out-alt fa-fw" style="font-weight: bold; font-size:20px; margin-left: 10px; color: white;"></i>
            </a>
            
          </ul>
          
        </div>
        <!-- End Sidebar can copy it to anthor file -->
  
        
      </div>



      









    </body>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="./circle-progress.js"></script>

    <script>








    document.querySelector(".HiddeLeftPar").addEventListener("click",(e)=>{

      let x = document.querySelector(".sidebar");

      if(x.style.display!=="none"){
        x.style.display="none";
        // document.querySelector(".HiddeLeftPar").innerHTML=`<i class="fa-solid fa-eye-slash"></i>`
      } else{
        x.style.display="block";
        // document.querySelector(".HiddeLeftPar").innerHTML=`<i class="fa-solid fa-eye"></i>`;
      }

    })









      function goToLogin(){
        location.href=location.origin+"/user.html";
      }











      function hideAllPages(e,pageName){

        pageName = pageName.replace("Page","Link");
        document.querySelector(".pageName").textContent=document.querySelector(`.${pageName}`).textContent.trim()

        document.querySelectorAll(".sidebar ul li a.active").forEach((e)=>{
          e.classList.remove("active");
        });

        document.querySelectorAll(".page-content").forEach((e)=>{
          e.style.display="none";
        });


        if(![...e.target.classList].includes("active")){
          e.target.classList.add("active");
        }

        let newPageName = pageName.replace("Link","Page");

        document.querySelector(`.${newPageName}`).style.display="block";

        if (window.matchMedia("(max-width: 600px)").matches) {
          document.querySelector(".HiddeLeftParSidebarBtn").click();
          
        }

      }


      const url = new URL(window.location.href);

      window.addEventListener("click",async(e)=>{

        
        if([...e.target.classList].includes("HiddeLeftParSidebarBtnHide")){
          document.querySelector(".sidebar").style.display="none";
        }


        if([...e.target.classList].includes("HomeLink")){
          hideAllPages(e,"HomeLink");
          url.searchParams.set("pageName", "HomeLink");
          window.history.pushState({}, '', url);
        }

        if([...e.target.classList].includes("WhatsAppQrLink")){
          hideAllPages(e,"WhatsAppQrLink");
          url.searchParams.set("pageName", "WhatsAppQrLink");
          window.history.pushState({}, '', url);
        }


        if([...e.target.classList].includes("WhatsAppChatbotLink")){
          hideAllPages(e,"WhatsAppChatbotLink");
          url.searchParams.set("pageName", "WhatsAppChatbotLink");
          window.history.pushState({}, '', url);
        }

        if([...e.target.classList].includes("WhatsAppSenderLink")){
          hideAllPages(e,"WhatsAppSenderLink");
          url.searchParams.set("pageName", "WhatsAppSenderLink");
          window.history.pushState({}, '', url);
        }

        if([...e.target.classList].includes("SubscriptionLink")){
          hideAllPages(e,"SubscriptionLink");
          url.searchParams.set("pageName", "SubscriptionLink");
          window.history.pushState({}, '', url);
        }


        if([...e.target.classList].includes("ProfileSettingsLink")){
          hideAllPages(e,"ProfileSettingsLink");
          url.searchParams.set("pageName", "ProfileSettingsLink");
          window.history.pushState({}, '', url);
        }




      })





      document.querySelector(".signup-box-show").addEventListener("click",()=>{
        document.querySelector(".login-box").style.display="none";
        document.querySelector(".signup-box").style.display="flex";
        document.querySelector(".signup-box-show").style.display="none";
        document.querySelector(".login-box-show").style.display="";
      });


      document.querySelector(".login-box-show").addEventListener("click",()=>{
        document.querySelector(".login-box").style.display="flex";
        document.querySelector(".signup-box").style.display="none";
        document.querySelector(".signup-box-show").style.display="";
        document.querySelector(".login-box-show").style.display="none";
      });



      document.querySelector(".signup-btn").addEventListener("click",async ()=>{

        const name = document.querySelector(".signup-name").value;
        const email = document.querySelector(".signup-email").value;
        const phone = document.querySelector(".signup-phone").value;
        const password = document.querySelector(".signup-password").value;

        if (!name || !email || !phone || !password || !email.includes('@gmail.com')) {
          Swal.fire({
            icon: 'error',
            title: 'برجاء ادخال جميع البيانات بشكل صحيح',
            text: '',
          });
          return;
        }

        try {
          const response = await fetch('/create-user', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ name, email, phone, password }),
          });

          const data = await response.json();

          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'تم انشاء الحساب يمكنك تسجيل الدخول',
              text: '',
            }).then(() => {
              document.querySelector(".login-box-show").click();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error creating user',
              text: data.message,
            });
          }
        } catch (error) {
          console.error('Error creating user:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error creating user',
            text: 'An unexpected error occurred.',
          });
        }

      })







      document.querySelector(".login-btn").addEventListener("click", async () => {

        const email = document.querySelector(".login-email").value;
        const password = document.querySelector(".login-password").value;

        if (!email || !password) {
          Swal.fire({
            icon: 'error',
            title: 'برجاء ادخال جميع البيانات بشكل صحيح',
            text: '',
          });
          return;
        }

        let userId = email;

        try {
          const result = await validatePassword(userId, password);
          if (result.isValid) {
            userData = result.data;
            localStorage.setItem(`whatsapp_chatbot_user_${userId}_password`, password);
            location.href = `?userId=${userId}`;

          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: `${result.data.message}`,
            });
            return false;
          }
        } catch (error) {
          console.error('Error validating password:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An unexpected error occurred.',
          });
        }
      });

















      // get user data


      

      const urlParams = new URLSearchParams(window.location.search);
      const userId = urlParams.get('userId');
      const pageName = urlParams.get('pageName');

      if(userId !== null && userId !== undefined && userId !== "" ){

        if(pageName!==null && pageName !==undefined && pageName !== ""){
          hideAllPages({target: document.querySelector(`.${pageName}`)},pageName);
        }

      } else{
        document.querySelector(".page").style.display="none";
      }


   


      let userData = {};
      let mainToken="";

      let startHour = 12||12;  
      let startHourampm = "AM";
      let endHour = 11||11;  
      let endHourampm = "PM"; 

      if(userId !== null && userId !== undefined && userId !== ""){

        document.querySelector(".loginDiv").style.display="none";

        // Fetch user existence
        fetch(`/check-user/${userId}`)
          .then(response => response.json())
          .then(async (data) => {
            if (data.success) {
              let userPassword = localStorage.getItem(`whatsapp_chatbot_user_${userId}_password`);
  
              if (userPassword) {
                // If password is stored locally, validate it
                await getUserData(userId, userPassword);
              } else {
                // Prompt user to enter password
                Swal.fire({
                  title: `Hi ${userId}, Enter your password`,
                  input: 'text',
                  inputAttributes: {
                    autocapitalize: 'off',
                    placeholder: 'Enter Your Password',
                  },
                  showCancelButton: true,
                  confirmButtonText: 'Submit',
                  showLoaderOnConfirm: true,
                  allowOutsideClick: false,
                  preConfirm: async (password) => {
                    if (!password) {
                      Swal.showValidationMessage('Password is required');
                      return false;
                    }
                    // Validate entered password
                    const result = await validatePassword(userId, password);
                    if (result.isValid) {
                      userData = result.data;
                      localStorage.setItem(`whatsapp_chatbot_user_${userId}_password`, password);
                      // showUserData(userData);
                      location.reload();
                      Swal.close();
                    } else {
                      Swal.showValidationMessage('Invalid password');
                      return false;
                    }
                  },
                  didOpen: () => {
                    const inputElement = Swal.getInput();
                    if (inputElement) {
                      inputElement.classList.add('passwordInput');
                    }
                  },
                });
              }
            } else {
              // User not found
              Swal.fire({
                icon: 'error',
                title: 'User not found!',
                text: '',
              });
            }
          })
          .catch(error => console.log('Error checking user:', error));

      }  



      

      // Function to fetch user data
      async function getUserData(userId, userPassword) {
        try {
          const response = await fetch(`/user-data`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ userId, password: userPassword }),
          });

          const data = await response.json();
          userData = data.data;

          if (userData) {
            mainToken = userData.token || mainToken;

            console.log("start checkToken")
            let resultToken=await checkToken(userData,userData.token);
            console.log("Token Result:",resultToken)

            if (resultToken.isValid) {


              userData.dayAiResponelimit = resultToken.data.dayLimit||100;
              userData.monthAiResponelimit = resultToken.data.monthLimit||100;

              showUserData(userData);



              let divOfTokenStartAndEndDate = `
              <div style="
                text-align: center;
                font-weight: bold;
                background: #3498dbc9;
                border-radius: 10px;
                padding: 15px;
                color: white;
                margin: 20px;
              ">
                بدا الاشتراك في تاريخ ( ${resultToken.data.startDate} ) و
                ينتهي في تاريخ  ( ${resultToken.data.endDate} )
                
                <a style="border-bottom: 2px solid white;  margin: 25px; cursor: pointer;" class="changeSubscriptionToken" onclick="changeSubscriptionToken()">تغيير كود الاشتراك</a>
              <div>
              `;

              document.querySelector('.SubscriptionPage').innerHTML += divOfTokenStartAndEndDate;

              getAiResponsMessagesCount();


            } else {
              enterToken(userData);
            }






          } else {

            localStorage.removeItem(`whatsapp_chatbot_user_${userId}_password`);

            Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: 'Invalid password!',
            });

          }
        } catch (error) {
          console.error('Error fetching user data:', error);
        }
      }

      // Function to validate password
      async function validatePassword(userId, password) {
        try {
          const response = await fetch(`/user-data`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ userId, password }),
          });

          const data = await response.json();
          return { isValid: data.success, data }; // Return an object with isValid and data
        } catch (error) {
          console.error('Error validating password:', error);
          return false;
        }
      }





      // Function to show user data
      async function showUserData(userData) {
         
        const qrDiv = document.querySelector('.qrDiv');
        const mainUserDiv = document.querySelector('.mainUserDiv');

        document.querySelector(".user-data").innerHTML=`
        
        
          <div class="container">
              <h1>User Information</h1>
              <div class="info">
                  <label for="name">Name:</label> <span id="name">${userData.name || "N/A"}</span>
              </div>
              <div class="info">
                  <label for="email">Email:</label> <span id="email">${userData.email || "N/A"}</span>
              </div>
              <div class="info">
                  <label for="phone">Phone Number:</label> <span id="phone">${userData.phone || "N/A"}</span>
              </div>
              <div class="info">
                  <label for="userId">User ID:</label> <span id="userId">${userData.id || "N/A"}</span>
              </div>
              <div class="info">
                  <label for="pageLink">Page Link:</label>  
                  <span id="pageLink">
                      <a href="${location.origin + '/user.html?userId=' + userData.id}" target="_blank">
                          View Profile
                      </a>
                  </span>
              </div>
          </div>





        
        
        `;

        document.querySelector("#AdminName").textContent=userData.name;

        console.log('user data:', userData);
        
        // Check if user has token
        if (userData.token) {
          mainToken = userData.token;
        }

          // Check if user has rules
        if (userData.rules!==undefined && userData.rules!==null && userData.rules!=="") {
          const rulesTextarea = document.querySelector('.mainRules');
          rulesTextarea.value = userData.rules;
          rulesTextarea.textContent = userData.rules;
        }

        // Check if user has chatbot status
        if (userData.isActive!==undefined && userData.isActive!==null) {

          const startBtn = document.getElementById("startBtn");
          const stopBtn = document.getElementById("stopBtn");
          console.log(userData.isActive);

          if (userData.isActive) {
            startBtn.style.display = "none";
            stopBtn.style.display = "block";
          } else {
            startBtn.style.display = "block";
            stopBtn.style.display = "none";
          }

        }



        if (userData.isLogin) {

          qrDiv.style.display = 'none';
          // mainUserDiv.style.display = 'block';
          document.querySelector(".startScanQrBtn").style.display="none";


          // Check if user has bot hours
          if (userData.startHour !==null && userData.endHour !==null && userData.startHourampm !==null && userData.endHourampm !==null) {
            startHour = userData.startHour;
            startHourampm = userData.startHourampm;
            endHour = userData.endHour;
            endHourampm = userData.endHourampm;


          }



 


        } else {
          qrDiv.style.display = 'block';
          // mainUserDiv.style.display = 'none';
          document.querySelector(".logout-btn").style.display="none";



        }

      }

      async function checkToken(userData, token) {

        console.log("Checking Token")
        const response = await fetch(`/get-token`, {
          method: 'POST',
          headers: {
        'Content-Type': 'application/json',
          },
          body: JSON.stringify({ userId: userId, password: userData.password, token }),
        });
        const data = await response.json();

        if (response.ok && data.success) {

          console.log(data.tokenData)
          return { isValid: true, data: data.tokenData };
        } else {

          return { isValid: false, message: data.message };
        }
      }


  
      async function enterToken(userData) {





        Swal.fire({
            title: 'ادخل كود الاشتراك',
            input: 'text',
            inputAttributes: {
              autocapitalize: 'off',
              placeholder: 'Enter Your Token',
            },
            showCancelButton: true,
            confirmButtonText: 'Submit',
            showLoaderOnConfirm: true,
            allowOutsideClick: false,
            preConfirm: async (token) => {
              if (!token) {
                Swal.showValidationMessage('Token is required');
              return false;
              }
              // Validate entered token
              const result = await checkToken(userData, token);
              if (result) {

                if (result.isValid) {
                  userData.token = token;
                  showUserData(userData);
                  location.reload();
                } else {
                  Swal.showValidationMessage(`${result.message}`);
                }

                
                
              } else {
                console.log("Token is invalid")
                Swal.showValidationMessage(`${result.message}`);
              return false;
              }
            },
        });


      };


      async function fetchQrCode(userId, password) {
        try {
          const response = await fetch(`/get-qr/${userId}?password=${password}&token=${mainToken}`);
          const data = await response.json();

          if (response.ok && data.success && data.qr) {
        console.log("QR Code Retrieved:", data.qr);
        return data.qr.qr; // Return the QR code
          } else if (data.message) {
        console.log("Message:", data.message);
          }
        } catch (error) {
          console.error("Error fetching QR code:", error);
          throw error; // Handle error
        }
      }




      function downloadPhoneNumbers() {
        fetch(`/download-user-phone-numbers/${userId}?password=${userData.password}&token=${mainToken}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
        })
          .then(response => {
            if (response.ok) {
              return response.blob();
            } else {
              throw new Error('Failed to download phone numbers');
            }
          })
          .then(blob => {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `${userId}_phone_numbers.csv`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
          })
          .catch(error => {
            console.error('Error downloading phone numbers:', error);
            Swal.fire({
              icon: 'error',
              title: 'Error downloading phone numbers',
              text: 'An unexpected error occurred.',
            });
          });
      }

      function toggleChatbot(state) {


        Swal.fire({
          title: 'Please Wait...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        const startBtn = document.getElementById("startBtn");
        const stopBtn = document.getElementById("stopBtn");

        if (state) {
          startBtn.style.display = "none";
          stopBtn.style.display = "block";
        } else {
          startBtn.style.display = "block";
          stopBtn.style.display = "none";
        }

        fetch(`/toggle-user-chatbot/${userId}?password=${userData.password}&token=${mainToken}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ isActive: state }),
        })
        .then(response => {
          if (!response.ok) {
            throw new Error('Failed to toggle chatbot state');
          }
          return response.json();
        })
        .then(data => {
          if (!data.success) {
            throw new Error(data.message);
          }
          console.log(`Chatbot state updated: ${state ? "active" : "inactive"}`);
        Swal.fire({
          icon: 'success',
          title: 'Chatbot state updated',
          text: `Chatbot is now ${state ? "active" : "inactive"}`,
        });
        })
        .catch(error => {
          console.error('Error toggling chatbot state:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error toggling chatbot state',
            text: 'An unexpected error occurred.',
          });
        });
      }







      async function saveRules() {



        Swal.fire({
          title: 'Please Wait...',
          allowOutsideClick: false,
          didOpen: () => {
            Swal.showLoading();
          }
        });

        const rulesTextarea = document.querySelector('.mainRules');
        const rules = rulesTextarea.value;

        try {
          const response = await fetch(`/save-rule/${userId}?password=${userData.password}&token=${mainToken}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ rules }),
          });

          const data = await response.json();

          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Rules saved successfully!',
              text: '',
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error saving rules',
              text: data.message,
            });
          }
        } catch (error) {
          console.error('Error saving rules:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error saving rules',
            text: 'An unexpected error occurred.',
          });
        }
      }













      

  
      function setChatbotHours() {
        Swal.fire({
          title: 'Set Chatbot Active Hours',
          html: `
            <label for="startHour">Start Hour (1-12):</label>
            <div style="display: flex; align-items: center; gap: 10px;  justify-content: center;">
              <select id="startHour" required>
                <!-- Default placeholder option -->
                <option value="" disabled selected>Select Hour</option>
                <!-- Dynamic selection -->
                <option value="1" ${Number(startHour) == 1 ? 'selected' : ''}>1</option>
                <option value="2" ${Number(startHour) == 2 ? 'selected' : ''}>2</option>
                <option value="3" ${Number(startHour) == 3 ? 'selected' : ''}>3</option>
                <option value="4" ${Number(startHour) == 4 ? 'selected' : ''}>4</option>
                <option value="5" ${Number(startHour) == 5 ? 'selected' : ''}>5</option>
                <option value="6" ${Number(startHour) == 6 ? 'selected' : ''}>6</option>
                <option value="7" ${Number(startHour) == 7 ? 'selected' : ''}>7</option>
                <option value="8" ${Number(startHour) == 8 ? 'selected' : ''}>8</option>
                <option value="9" ${Number(startHour) == 9 ? 'selected' : ''}>9</option>
                <option value="10" ${Number(startHour) == 10 ? 'selected' : ''}>10</option>
                <option value="11" ${Number(startHour) == 11 ? 'selected' : ''}>11</option>
                <option value="12" ${Number(startHour) == 12 ? 'selected' : ''}>12</option>
              </select>
  
              <select id="startHourampm" required>
                <!-- Check if startHourampm is dynamically set and use it as the default -->
                <option value="" disabled selected>Select AM/PM</option>
                <option value="AM" ${startHourampm === 'AM' ? 'selected' : ''}>AM</option>
                <option value="PM" ${startHourampm === 'PM' ? 'selected' : ''}>PM</option>
              </select>
  
            </div>
            <br>
  
            <label for="endHour">End Hour (1-12):</label>
            <div style="display: flex; align-items: center; gap: 10px; justify-content: center;">
              <select id="endHour" required>
                <!-- Default placeholder option -->
                <option value="" disabled selected>Select Hour</option>
                <!-- Dynamic selection -->
                <option value="1" ${Number(endHour) == 1 ? 'selected' : ''}>1</option>
                <option value="2" ${Number(endHour) == 2 ? 'selected' : ''}>2</option>
                <option value="3" ${Number(endHour) == 3 ? 'selected' : ''}>3</option>
                <option value="4" ${Number(endHour) == 4 ? 'selected' : ''}>4</option>
                <option value="5" ${Number(endHour) == 5 ? 'selected' : ''}>5</option>
                <option value="6" ${Number(endHour) == 6 ? 'selected' : ''}>6</option>
                <option value="7" ${Number(endHour) == 7 ? 'selected' : ''}>7</option>
                <option value="8" ${Number(endHour) == 8 ? 'selected' : ''}>8</option>
                <option value="9" ${Number(endHour) == 9 ? 'selected' : ''}>9</option>
                <option value="10" ${Number(endHour) == 10 ? 'selected' : ''}>10</option>
                <option value="11" ${Number(endHour) == 11 ? 'selected' : ''}>11</option>
                <option value="12" ${Number(endHour) == 12 ? 'selected' : ''}>12</option>
              </select>
  
  
              <select id="endHourampm" required>
                <!-- Default placeholder option -->
                <option value="" disabled selected>Select AM/PM</option>
                <!-- Dynamic selection -->
                <option value="AM" ${endHourampm === 'AM' ? 'selected' : ''}>AM</option>
                <option value="PM" ${endHourampm === 'PM' ? 'selected' : ''}>PM</option>
              </select>
            </div>
            <br>
  
          `,
          focusConfirm: false,
          preConfirm: () => {

            
            startHour = document.getElementById('startHour').value;
            endHour = document.getElementById('endHour').value;
  
            startHourampm = document.getElementById('startHourampm').value;
            endHourampm = document.getElementById('endHourampm').value;
  
            // Validate inputs
            if (startHour < 1 || startHour > 12 || endHour < 1 || endHour > 12) {
              Swal.showValidationMessage('Please enter valid hours');
              return false;
            }
  
            // Validate inputs
            if (startHour == endHour && startHourampm == endHourampm) {
              Swal.showValidationMessage('Please enter valid hours cannot be the same');
              return false;
            }



            Swal.fire({
              title: 'Please Wait...',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              }
            });

  
            // Send the start and end hours to the server via fetch
            fetch(`/set-user-chatbot-hours/${userId}?password=${userData.password}&token=${mainToken}`, {
              method: 'POST',
              headers: {
              'Content-Type': 'application/json',
              },
              body: JSON.stringify({ startHour: parseInt(startHour), endHour: parseInt(endHour), startHourampm, endHourampm }),
            })
              .then((response) => response.json())
              .then((data) => {
              if (data.success) {
                startHour = startHour;
                endHour = endHour;
                startHourampm = startHourampm;
                endHourampm = endHourampm;
        
                // success swal here
                Swal.fire({
                title: `Hours Set Successfully From ${startHour} ${startHourampm} To ${endHour} ${endHourampm}`,
                icon: 'success',
                });
        
              } else {
                Swal.fire('Error setting hours');
              }
              })
              .catch((error) => {
              Swal.fire('Error setting hours');
              console.error('Error:', error);
              });
            }


        });
      }
  
  





      async function startWhatsAppSender() {
     
        startBulkMessaging();

      }



        // Function to start sending messages
        async function startBulkMessaging() {
          let fileInput = document.querySelector("#fileUpload");
          let file = fileInput.files[0];
          let phoneNumbers = []; // Initialize phoneNumbers array

          if (file && (file.name.endsWith('.xlsx') || file.name.endsWith('.xls') || file.name.endsWith('.csv'))) {
            let reader = new FileReader();

            reader.onload = async function (e) {
              try {
                let data = e.target.result;

                if (file.name.endsWith('.csv')) {
                  // Parse CSV file
                  let rows = data.split('\n').map(row => row.split(',')[0].trim());
                  phoneNumbers = rows.filter(num => num); // Filter out empty rows
                } else {
                  // Parse Excel file
                  let workbook = XLSX.read(data, { type: 'binary' });
                  let sheet = workbook.Sheets[workbook.SheetNames[0]]; // First sheet
                  let rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                  phoneNumbers = rows.map(row => row[0]?.toString().trim()).filter(num => num).map(num => `"${num}"`);; // Filter out invalid rows
                }

                console.log('Phone Numbers:', phoneNumbers);

                if (phoneNumbers.length === 0) {
                  Swal.fire('Error', 'No valid phone numbers found in the file.', 'error');
                  return;
                }

                // Proceed with messaging
                await processMessages(phoneNumbers);
              } catch (error) {
                console.error('Error processing file:', error);
                Swal.fire('Error', 'Failed to process the file. Please ensure it is valid.', 'error');
              }
            };

            if (file.name.endsWith('.csv')) {
              reader.readAsText(file);
            } else {
              reader.readAsBinaryString(file);
            }
          } else {
            Swal.fire('Error', 'Please upload a valid Excel or CSV file.', 'error');
          }
        }

        let showCounterForMessages=true;

        let divOfNumbersDone="";
        async function processMessages(phoneNumbers) {
          
          let message = document.querySelector(".messageTextareaForSender").value;
          let countryCode = document.getElementById('countryCode').value;
          // Get settings
          let messageDelay = parseInt(document.getElementById('messageDelay').value) || 2;
          let batchDelay = parseInt(document.getElementById('batchDelay').value) || 10;


          for (let i = 0; i < phoneNumbers.length; i++) {
            let phoneNumber = phoneNumbers[i];


            // Send message via WhatsApp Web JS (assuming client is initialized)
            
            await sendMessage(phoneNumber,message,countryCode,phoneNumbers.length,i);
            // Wait for the specified delay between messages
            if (i < phoneNumbers.length - 1) {
              await delay(messageDelay * 1000); // Delay in milliseconds
            }
    
            // After a certain number of messages, add a batch delay
            if ((i + 1) % batchDelay === 0) {
              console.log(`Batch completed. Waiting for ${batchDelay} seconds...`);
              await delay(batchDelay * 1000);
            }
            

            // stop 
            if(!showCounterForMessages){
              break;
            }

          }

          
        }

        // Utility function to delay execution
        function delay(ms) {
          return new Promise(resolve => setTimeout(resolve, ms));
        }

        // Placeholder for removing country code
        function removeCountryCodeFromNumber(phoneNumber) {
          // Implement logic to remove country code
          return phoneNumber.replace(/^\+\d{1,3}/, ''); // Example: Removes +123
        }

      

        // Placeholder for sending messages
        async function sendMessage(phoneNumber,message,countryCode,phoneNumbersLength,doneMessages) {

            // console.log(phoneNumber); // "201551425189"
            // console.log(" ");
            // Ensure the phone number is correctly formatted
            phoneNumber = phoneNumber.replace(/\D/g, ''); // Remove any non-digit characters


          
            // Send message using the /send-user-whatsapp-message endpoint
            fetch(`/send-user-whatsapp-message/${userId}?password=${userData.password}&token=${mainToken}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ phoneNumber, message: `${message}`, countryCode: `${countryCode}` }),
            }).then(response => {
            if (response.ok) {
              console.log(`Message sent to ${phoneNumber}`);

              divOfNumbersDone+=`
              
                <tr>
                  <td>${countryCode}${phoneNumber}</td>
                  <td>Done</td>
                </tr>

              `;
              
              // show swal has all numbers sended in taple and statues done and  message (numberMessagesDone/numberMessagesleft) and button to stop
              if(showCounterForMessages){
              Swal.fire({
                title: 'Messages Status',
                html: `
                <table>
                  <thead>
                  <tr>
                    <th>Phone Number</th>
                    <th>Status</th>
                  </tr>
                  </thead>
                  <tbody class="phoneNumbersTable">
                    <tr>
                      <td>(${doneMessages+1}/${phoneNumbersLength})</td>
                    </tr>

                    ${divOfNumbersDone}
                     
                  </tbody>
                </table>
                
                `,
                showConfirmButton: true,
                showCancelButton: false,
                confirmButtonText: 'Stop And Cancel',
                confirmButtonColor: 'red',
                allowOutsideClick: false,
              }).then((result) => {
                if (result.isConfirmed) {
                showCounterForMessages=false;
                window.location.reload();
                } 
              });
              }

              console.log(`Sending message to ${phoneNumber}`);

              if(phoneNumbersLength-1==doneMessages){
              Swal.fire('Messages Sent Successfully', 'All messages have been sent successfully.', 'success');
              }

            } else {
              console.error(`Error sending message to ${phoneNumber}`);
            }
            
            })
          

      }








      async function logoutUser() {
        Swal.fire({
          title: 'Are you sure you want to logout?',
          showCancelButton: true,
          confirmButtonText: 'Logout',
          showLoaderOnConfirm: true,
          preConfirm: async () => {
        try {

          Swal.fire({
            title: 'Logging out...',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });


          // const response = await fetch(`/logout-user/${userId}?password=${userData.password}&token=${mainToken}`, {
          //   method: 'GET',
          //   headers: {
          // 'Content-Type': 'application/json',
          //   },
          // });

          const response = await fetch(`/logout-user/${userId}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              password: userData.password,
              token: mainToken,
            }),
          });


          const data = await response.json();

          if (data.success) {
            Swal.fire({
          icon: 'success',
          title: 'Logged out successfully',
          text: data.message,
            }).then(() => {
      
          window.location.reload();
            });
          } else {
            Swal.fire({
          icon: 'error',
          title: 'Error logging out',
          text: data.message,
            });
          }
        } catch (error) {
          console.error('Error logging out:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error logging out',
            text: 'An unexpected error occurred.',
          });
        }
          },
        });
      }



      async function changeSubscriptionToken(){
        enterToken(userData);
      }





      let qrInterval;

      async function startScanQr() {
        let qrDiv = document.querySelector('.qrDiv');
        let startScanQrBtn = document.querySelector('.startScanQrBtn');
        let scanUserQrDiv = document.querySelector('.scanUserQrDiv');
        let qrCodeImg = document.querySelector('.qrCodeImg');

        scanUserQrDiv.style.display = 'block';
        startScanQrBtn.style.display = 'none';

        if (qrInterval) {
          clearInterval(qrInterval);
        }

        try {
          let qrCode = await fetchQrCode(userId, userData.password);
          console.log(qrCode);
          if(qrCode!==null&&qrCode!==undefined){
            qrCodeImg.src = qrCode;
          } else {
            qrCodeImg.src=`./imgs/loading.jpg`;
          }
          console.log("qr updated");

          qrInterval = setInterval(async () => {
            let qrCode = await fetchQrCode(userId, userData.password);
            console.log(qrCode);
            if(qrCode!==null&&qrCode!==undefined){
              qrCodeImg.src = qrCode;
            } else {
              qrCodeImg.src=`./imgs/loading.jpg`;
            }
            console.log("qr updated");
          }, 10000);
        } catch (error) {
          console.log('Error get QR code:', error);
          scanUserQrDiv.style.display = 'none';
        }
      }






      function showCharts(messageCounts) {
        console.log(messageCounts);

        const data = [
          messageCounts.messagesToday,
          messageCounts.messagesThisWeek,
          messageCounts.messagesThisMonth,
          messageCounts.messagesThisYear
        ];

        const ctx = document.getElementById('combinedChart').getContext('2d');

        const combinedChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: [
              `(${messageCounts.messagesToday})` + ' اليوم',
              `(${messageCounts.messagesThisWeek})` + ' هذا الأسبوع',
              `(${messageCounts.messagesThisMonth})` + ' هذا الشهر',
              `(${messageCounts.messagesThisYear})` + ' هذا العام'
            ],
            datasets: [{
              label: 'عدد الرسائل التي تم الرد عليها',
              data: data,
              backgroundColor: [
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(192, 75, 75, 0.6)'
              ],
              borderColor: [
                'rgba(75, 192, 192, 1)',
                'rgba(153, 102, 255, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(192, 75, 75, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  font: {
                    family: 'Cairo', // Set the font family
                    size: 14 // Adjust font size if needed
                  }
                }
              },
              x: {
                ticks: {
                  font: {
                    family: 'Cairo',
                    size: 14
                  }
                }
              }
            },
            plugins: {
              legend: {
                labels: {
                  font: {
                    family: 'Cairo',
                    size: 14
                  }
                }
              }
            }
          }
        });

      }

      async function getAiResponsMessagesCount() {
        try {
          const response = await fetch(`/get-user-ai-messages-count/${userId}?password=${userData.password}&token=${mainToken}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
          });
          const data = await response.json();

          if (data.success) {
            console.log("AI Response Message Counts:", data.messageCounts);

            // Update the charts with the fetched data
            showCharts(data.messageCounts);

            console.log("userData:",userData);
 
            let userDataLimit = {
              messagesToday: Number( data.messageCountsFromSpecificDate.messagesToday ),
              messagesFromDate:Number(  data.messageCountsFromSpecificDate.messagesFromDate ),
              dayAiResponseLimit: Number( userData.tokenData.dayLimit) ,
              monthAiResponseLimit: Number( userData.tokenData.monthLimit) 
            };
            console.log("userDataLimit:",userDataLimit);

            // Call function
            showChartsLimit(userDataLimit);

            // showChartsLimit(data.messageCounts, userDataLimit);

          } else {
        console.error("Error fetching AI response message counts:", data.message);
          }
        } catch (error) {
          console.error("Error fetching AI response message counts:", error);
        }
      }












           
            async function fetchAiMessageSummary(range) {

              Swal.fire({
                title: 'Please Wait...',
                allowOutsideClick: false,
                didOpen: () => {
                  Swal.showLoading();
                }
              });







              try {
                const response = await fetch(`/get-ai-message-summary/${userId}?password=${userData.password}&token=${mainToken}&range=${range}`, {
                  method: 'POST',
                  headers: {
                  'Content-Type': 'application/json',
                },
              });

              const data = await response.json();

              if (data.success) {
                // console.log("AI Message Summary:", data.summary);
                // Display the summary in a textarea
                Swal.fire({
                  title: 'ملخص الرسائل',
                  html: `<textarea dir="auto" readonly style="font-weight: bolder; width: 100%; height: 600px; border-radius: 10px; padding: 10px; font-family: cairo;">${data.summary}</textarea>`,
                  width: '1000px',
                });
              } else {
                console.error("Error fetching AI message summary:", data.message);
                Swal.fire({
                  icon: 'error',
                  title: 'Error fetching AI message summary',
                  text: data.message,
                });
                }
              } catch (error) {
                console.error("Error fetching AI message summary:", error);
                Swal.fire({
                  icon: 'error',
                  title: 'Error fetching AI message summary',
                  text: 'An unexpected error occurred.',
                });
              }
            }










            function showChartsLimit(userDataLimit) {


              console.log("show showChartsLimit");
              console.log(mainToken);
              console.log("userDataLimit: ", userDataLimit);
              // Ensure we have valid limits (prevent division by zero)
              const dayLimit = userDataLimit.dayAiResponseLimit || 1;
              const monthLimit = userDataLimit.monthAiResponseLimit || 1;

              // Calculate Progress Percentage
              const todayProgress = (userDataLimit.messagesToday / dayLimit) * 100;
              const monthProgress = (userDataLimit.messagesFromDate / monthLimit) * 100;

              // Initialize Circle Progress for daily limit
              let dailyCircleProgress = new CircleProgress('.daily-progress', {
                value: Math.round(todayProgress),
                max: 100,
                textFormat: 'percent',
              });
              document.querySelector(".daily-progress-text").textContent = `(${userDataLimit.messagesToday}/${dayLimit})`;
              document.querySelector(".daily-progress-text").style = `
                color: black;
                font-size: 18px;
                font-weight: bold;
                font-family: cairo;
                padding: 10px;
                text-align: center;
              `;
              document.querySelector(".daily-progress").style.width = "100%";


              // Initialize Circle Progress for monthly limit
              let monthlyCircleProgress = new CircleProgress('.monthly-progress', {
                value: Math.round(monthProgress),
                max: 100,
                textFormat: 'percent',
              });
              document.querySelector(".monthly-progress-text").textContent = `(${userDataLimit.messagesFromDate}/${monthLimit})`;
              document.querySelector(".monthly-progress-text").style = `
                color: black;
                font-size: 18px;
                font-weight: bold;
                font-family: cairo;
                padding: 10px;
                text-align: center;
              `;
              document.querySelector(".monthly-progress").style.width = "100%";
            }









    </script>
  
  </html>